@page
@using Microsoft.AspNetCore.Mvc.Localization
@model SmartAdmin.WebUI.Pages.Reports.SearchModel
@inject IStringLocalizer<SearchModel> _localizer

@{
    ViewData["Title"] = "Transaction Search";
    ViewData["PageName"] = "reports_search";
    ViewData["PreemptiveClass"] = "Default";

    var searchUrl = Url.Page("/Reports/Search", "Search");
}

@section HeadBlock {
    <link rel="stylesheet" media="screen, print" href="~/css/fa-solid.css">
    <link rel="stylesheet" media="screen, print" href="~/css/datagrid/datatables/datatables.bundle.css">
    <link rel="stylesheet" media="screen, print" href="~/css/formplugins/select2/select2.bundle.css">
    <link rel="stylesheet" media="screen,print" href="~/lib/easyui/themes/insdep/easyui.css">
    <style>
        .search-card {
            border-left: 4px solid #667eea;
        }
        .search-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        .quick-search-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .settlement-badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }
        .case-link {
            color: #007bff;
            text-decoration: none;
        }
        .case-link:hover {
            text-decoration: underline;
        }
        .detail-modal-label {
            font-weight: 600;
            color: #6c757d;
        }
        .detail-modal-value {
            font-weight: 500;
        }
        .search-hint {
            font-size: 0.75rem;
            color: #6c757d;
        }
    </style>
}

<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h1 class="subheader-title">
                <i class="subheader-icon @(Settings.Theme.IconPrefix) fa-search"></i> @_localizer["Transaction Search"]
            </h1>
            <small class="text-muted">@_localizer["Search transactions by ID, player, amount, or other criteria"]</small>
        </div>
        <div>
            <a asp-page="/Reports/Index" class="btn btn-outline-primary waves-effect waves-themed">
                <i class="@(Settings.Theme.IconPrefix) fa-chart-bar mr-1"></i>
                @_localizer["Transaction Report"]
            </a>
        </div>
    </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
    <div class="col-xl-12">
        <div class="card search-card">
            <div class="card-body">
                <form id="searchForm" class="needs-validation" novalidate>
                    @Html.AntiForgeryToken()

                    <!-- Quick Search Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="search-section-title">
                                <i class="@(Settings.Theme.IconPrefix) fa-bolt mr-1"></i>
                                @_localizer["Quick Search"]
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label class="form-label">
                                    <i class="@(Settings.Theme.IconPrefix) fa-fingerprint mr-1"></i>
                                    @_localizer["Transaction ID"]
                                </label>
                                <input type="text" asp-for="TransactionId" class="form-control" id="transactionId"
                                       placeholder="@_localizer["Enter transaction ID..."]" autocomplete="off" />
                                <small class="search-hint">@_localizer["Partial match supported"]</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label class="form-label">
                                    <i class="@(Settings.Theme.IconPrefix) fa-id-card mr-1"></i>
                                    @_localizer["External Payment ID"]
                                </label>
                                <input type="text" asp-for="ExternalPaymentId" class="form-control" id="externalPaymentId"
                                       placeholder="@_localizer["Enter external payment ID..."]" autocomplete="off" />
                                <small class="search-hint">@_localizer["Partial match supported"]</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label class="form-label">
                                    <i class="@(Settings.Theme.IconPrefix) fa-user mr-1"></i>
                                    @_localizer["Player ID"]
                                </label>
                                <input type="text" asp-for="PlayerId" class="form-control" id="playerId"
                                       placeholder="@_localizer["Enter player ID..."]" autocomplete="off" />
                                <small class="search-hint">@_localizer["Partial match supported"]</small>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Filters Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="search-section-title">
                                <i class="@(Settings.Theme.IconPrefix) fa-filter mr-1"></i>
                                @_localizer["Advanced Filters"]
                                <button type="button" class="btn btn-xs btn-outline-secondary float-right" id="toggleAdvanced">
                                    <i class="@(Settings.Theme.IconPrefix) fa-chevron-down mr-1"></i>
                                    @_localizer["Show/Hide"]
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="advancedFilters">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-building mr-1"></i>
                                        @_localizer["PSP"]
                                    </label>
                                    <select asp-for="SelectedPspId" asp-items="Model.Psps" class="form-control select2" id="pspSelector">
                                        <option value="">@_localizer["All PSPs"]</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-tag mr-1"></i>
                                        @_localizer["Status"]
                                    </label>
                                    <select asp-for="Status" asp-items="Model.Statuses" class="form-control" id="statusSelector"></select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-coins mr-1"></i>
                                        @_localizer["Currency"]
                                    </label>
                                    <select asp-for="CurrencyCode" asp-items="Model.Currencies" class="form-control" id="currencySelector"></select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <!-- Placeholder for alignment -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-dollar-sign mr-1"></i>
                                        @_localizer["Amount From"]
                                    </label>
                                    <input type="number" asp-for="AmountFrom" class="form-control" id="amountFrom"
                                           step="0.01" min="0" placeholder="0.00" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-dollar-sign mr-1"></i>
                                        @_localizer["Amount To"]
                                    </label>
                                    <input type="number" asp-for="AmountTo" class="form-control" id="amountTo"
                                           step="0.01" min="0" placeholder="0.00" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-calendar mr-1"></i>
                                        @_localizer["Date From"]
                                    </label>
                                    <input type="date" asp-for="DateFrom" class="form-control" id="dateFrom" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="form-label">
                                        <i class="@(Settings.Theme.IconPrefix) fa-calendar mr-1"></i>
                                        @_localizer["Date To"]
                                    </label>
                                    <input type="date" asp-for="DateTo" class="form-control" id="dateTo" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-3">
                        <div class="col-12 d-flex justify-content-between">
                            <div>
                                <button type="button" id="clearBtn" class="btn btn-outline-secondary waves-effect waves-themed">
                                    <i class="@(Settings.Theme.IconPrefix) fa-eraser mr-1"></i>
                                    @_localizer["Clear All"]
                                </button>
                            </div>
                            <div>
                                <button type="submit" id="searchBtn" class="btn btn-primary waves-effect waves-themed">
                                    <i class="@(Settings.Theme.IconPrefix) fa-search mr-1"></i>
                                    @_localizer["Search"]
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Results Panel -->
<div class="row">
    <div class="col-xl-12">
        <div id="panel-results" class="panel">
            <div class="panel-hdr">
                <h2>
                    <i class="@(Settings.Theme.IconPrefix) fa-list mr-2"></i>
                    @_localizer["Search Results"]
                    <span class="fw-300" id="resultCount"></span>
                </h2>
                <div class="panel-toolbar">
                    <button class="btn btn-panel waves-effect waves-themed" data-action="panel-collapse" data-toggle="tooltip" data-original-title="Collapse"></button>
                    <button class="btn btn-panel waves-effect waves-themed" data-action="panel-fullscreen" data-toggle="tooltip" data-original-title="Fullscreen"></button>
                </div>
            </div>
            <div class="panel-container show">
                <div class="panel-content p-0">
                    <table id="searchResultsGrid"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Detail Modal -->
<div class="modal fade" id="transactionDetailModal" tabindex="-1" role="dialog" aria-labelledby="transactionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary-600">
                <h5 class="modal-title text-white" id="transactionDetailModalLabel">
                    <i class="@(Settings.Theme.IconPrefix) fa-info-circle mr-2"></i>
                    @_localizer["Transaction Details"]
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="transactionDetailContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">@_localizer["Close"]</button>
                <a id="viewCaseBtn" href="#" class="btn btn-warning" style="display: none;">
                    <i class="@(Settings.Theme.IconPrefix) fa-exclamation-triangle mr-1"></i>
                    @_localizer["View Case"]
                </a>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script type="text/javascript" src="~/lib/easyui/jquery.easyui.min.js" asp-append-version="true"></script>
    <script type="text/javascript" src="~/lib/easyui/plugins/datagrid-filter.js" asp-append-version="true"></script>
    <script type="text/javascript" src="~/lib/easyui/jquery.easyui.component.js" asp-append-version="true"></script>
    <script>jQuery.fn.tooltip = bootstrapTooltip;</script>
    <script src="~/lib/axios/dist/axios.js"></script>
    <script src="~/js/formplugins/select2/select2.bundle.js"></script>

    <script>
        $(function () {
            'use strict';

            var $dg;
            var hasSearched = false;

            // Initialize Select2
            $('.select2').select2({
                placeholder: '@_localizer["All PSPs"]',
                allowClear: true
            });

            // Toggle advanced filters
            $('#toggleAdvanced').on('click', function() {
                $('#advancedFilters').slideToggle();
                var icon = $(this).find('i');
                icon.toggleClass('fa-chevron-down fa-chevron-up');
            });

            // Initialize DataGrid
            $dg = $('#searchResultsGrid').datagrid({
                fit: false,
                fitColumns: false,
                height: (window.innerHeight - 550),
                striped: true,
                rownumbers: true,
                pagination: true,
                pageSize: 25,
                pageList: [10, 25, 50, 100],
                sortName: 'TxDate',
                sortOrder: 'desc',
                remoteSort: true,
                singleSelect: true,
                columns: [[
                    {
                        field: 'TxDate',
                        title: '@_localizer["Date"]',
                        sortable: true,
                        width: 150,
                        formatter: function(value) {
                            return value ? new Date(value).toLocaleString() : '';
                        }
                    },
                    {
                        field: 'TxId',
                        title: '@_localizer["Transaction ID"]',
                        sortable: true,
                        width: 150
                    },
                    {
                        field: 'PspName',
                        title: '@_localizer["PSP"]',
                        sortable: true,
                        width: 120
                    },
                    {
                        field: 'PlayerId',
                        title: '@_localizer["Player ID"]',
                        sortable: true,
                        width: 150
                    },
                    {
                        field: 'Amount',
                        title: '@_localizer["Amount"]',
                        sortable: true,
                        width: 100,
                        align: 'right',
                        formatter: function(value, row) {
                            return value != null ? value.toFixed(2) + ' ' + (row.CurrencyCode || '') : '';
                        }
                    },
                    {
                        field: 'Status',
                        title: '@_localizer["Status"]',
                        sortable: true,
                        width: 100,
                        formatter: function(value) {
                            var cls = value === 'completed' ? 'badge-success' : 'badge-secondary';
                            return '<span class="badge ' + cls + '">' + value + '</span>';
                        }
                    },
                    {
                        field: 'SettlementStatusDisplay',
                        title: '@_localizer["Settlement"]',
                        sortable: false,
                        width: 110,
                        formatter: function(value, row) {
                            if (row.IsSettled) {
                                var cls = 'badge-success';
                                if (row.SettlementStatus === 2) cls = 'badge-warning';
                                if (row.SettlementStatus === 0) cls = 'badge-danger';
                                return '<span class="badge settlement-badge ' + cls + '">' + value + '</span>';
                            }
                            return '<span class="badge settlement-badge badge-secondary">Not Settled</span>';
                        }
                    },
                    {
                        field: 'CaseNumber',
                        title: '@_localizer["Case"]',
                        sortable: false,
                        width: 100,
                        formatter: function(value, row) {
                            if (value) {
                                return '<a href="/Cases/Details?id=' + row.CaseId + '" class="case-link">' + value + '</a>';
                            }
                            return '<span class="text-muted">-</span>';
                        }
                    },
                    {
                        field: 'actions',
                        title: '@_localizer["Actions"]',
                        width: 80,
                        align: 'center',
                        formatter: function(value, row) {
                            return '<button class="btn btn-xs btn-outline-info view-details" data-id="' + row.Id + '" title="@_localizer["View Details"]"><i class="fal fa-eye"></i></button>';
                        }
                    }
                ]],
                onBeforeLoad: function(param) {
                    if (!hasSearched) {
                        return false;
                    }
                },
                loader: function(param, success, error) {
                    var queryParams = {
                        transactionId: $('#transactionId').val() || null,
                        externalPaymentId: $('#externalPaymentId').val() || null,
                        playerId: $('#playerId').val() || null,
                        pspId: $('#pspSelector').val() || null,
                        amountFrom: $('#amountFrom').val() || null,
                        amountTo: $('#amountTo').val() || null,
                        dateFrom: $('#dateFrom').val() || null,
                        dateTo: $('#dateTo').val() || null,
                        status: $('#statusSelector').val() || null,
                        currencyCode: $('#currencySelector').val() || null,
                        page: param.page || 1,
                        rows: param.rows || 25,
                        sort: param.sort || 'TxDate',
                        order: param.order || 'desc'
                    };

                    axios.get('@searchUrl', { params: queryParams })
                        .then(function(res) {
                            if (res.data && res.data.succeeded && res.data.data) {
                                toastr.info(res.data.message);
                                $('#resultCount').html('<i>(' + res.data.data.total + ' @_localizer["found"])</i>');
                                success(res.data.data);
                            } else {
                                error();
                            }
                        })
                        .catch(function(err) {
                            toastr.error('@_localizer["Search failed"]: ' + err.message);
                            error();
                        });
                },
                onLoadSuccess: function() {
                    // Bind view details buttons
                    $('.view-details').on('click', function() {
                        var id = $(this).data('id');
                        showTransactionDetails(id);
                    });
                }
            });

            // Form submit handler
            $('#searchForm').on('submit', function(e) {
                e.preventDefault();
                hasSearched = true;
                $dg.datagrid('load');
            });

            // Clear button handler
            $('#clearBtn').on('click', function() {
                $('#searchForm')[0].reset();
                $('#pspSelector').val('').trigger('change');
                hasSearched = false;
                $dg.datagrid('loadData', { rows: [], total: 0 });
                $('#resultCount').html('');
            });

            // Show transaction details
            function showTransactionDetails(id) {
                var rows = $dg.datagrid('getRows');
                var transaction = rows.find(function(r) { return r.Id === id; });

                if (!transaction) {
                    toastr.error('@_localizer["Transaction not found"]');
                    return;
                }

                var html = '<div class="row">';

                // Transaction Info
                html += '<div class="col-md-6">';
                html += '<h6 class="mb-3"><i class="fal fa-exchange-alt mr-2"></i>@_localizer["Transaction Information"]</h6>';
                html += '<table class="table table-sm table-borderless">';
                html += '<tr><td class="detail-modal-label">@_localizer["Transaction ID"]:</td><td class="detail-modal-value">' + (transaction.TxId || '-') + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["External Payment ID"]:</td><td class="detail-modal-value">' + (transaction.ExternalPaymentId || '-') + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["Date"]:</td><td class="detail-modal-value">' + new Date(transaction.TxDate).toLocaleString() + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["Amount"]:</td><td class="detail-modal-value">' + transaction.Amount.toFixed(2) + ' ' + transaction.CurrencyCode + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["Status"]:</td><td class="detail-modal-value"><span class="badge badge-' + (transaction.Status === 'completed' ? 'success' : 'secondary') + '">' + transaction.Status + '</span></td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["Action"]:</td><td class="detail-modal-value">' + (transaction.Action || '-') + '</td></tr>';
                html += '</table>';
                html += '</div>';

                // Player & PSP Info
                html += '<div class="col-md-6">';
                html += '<h6 class="mb-3"><i class="fal fa-user mr-2"></i>@_localizer["Player & PSP Information"]</h6>';
                html += '<table class="table table-sm table-borderless">';
                html += '<tr><td class="detail-modal-label">@_localizer["Player ID"]:</td><td class="detail-modal-value">' + (transaction.PlayerId || '-') + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["Brand"]:</td><td class="detail-modal-value">' + (transaction.BrandId || '-') + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["PSP"]:</td><td class="detail-modal-value">' + (transaction.PspName || '-') + '</td></tr>';
                html += '<tr><td class="detail-modal-label">@_localizer["External System"]:</td><td class="detail-modal-value">' + (transaction.ExternalSystem || '-') + '</td></tr>';
                html += '</table>';
                html += '</div>';

                html += '</div><hr>';
                html += '<div class="row">';

                // Settlement Info
                html += '<div class="col-md-6">';
                html += '<h6 class="mb-3"><i class="fal fa-check-circle mr-2"></i>@_localizer["Settlement Information"]</h6>';
                html += '<table class="table table-sm table-borderless">';
                html += '<tr><td class="detail-modal-label">@_localizer["Status"]:</td><td class="detail-modal-value">' + transaction.SettlementStatusDisplay + '</td></tr>';
                if (transaction.IsSettled) {
                    html += '<tr><td class="detail-modal-label">@_localizer["Fees"]:</td><td class="detail-modal-value">' + (transaction.TotalFees != null ? transaction.TotalFees.toFixed(2) : '-') + '</td></tr>';
                    html += '<tr><td class="detail-modal-label">@_localizer["Net Settlement"]:</td><td class="detail-modal-value">' + (transaction.NetSettlement != null ? transaction.NetSettlement.toFixed(2) : '-') + '</td></tr>';
                    html += '<tr><td class="detail-modal-label">@_localizer["Settlement Date"]:</td><td class="detail-modal-value">' + (transaction.SettlementDate ? new Date(transaction.SettlementDate).toLocaleDateString() : '-') + '</td></tr>';
                }
                html += '</table>';
                html += '</div>';

                // Case Info
                html += '<div class="col-md-6">';
                html += '<h6 class="mb-3"><i class="fal fa-exclamation-triangle mr-2"></i>@_localizer["Case Information"]</h6>';
                if (transaction.CaseNumber) {
                    html += '<table class="table table-sm table-borderless">';
                    html += '<tr><td class="detail-modal-label">@_localizer["Case Number"]:</td><td class="detail-modal-value">' + transaction.CaseNumber + '</td></tr>';
                    html += '<tr><td class="detail-modal-label">@_localizer["Title"]:</td><td class="detail-modal-value">' + (transaction.CaseTitle || '-') + '</td></tr>';
                    html += '<tr><td class="detail-modal-label">@_localizer["Status"]:</td><td class="detail-modal-value">' + (transaction.CaseStatus || '-') + '</td></tr>';
                    html += '</table>';
                    $('#viewCaseBtn').attr('href', '/Cases/Details?id=' + transaction.CaseId).show();
                } else {
                    html += '<p class="text-muted">@_localizer["No case associated with this transaction."]</p>';
                    $('#viewCaseBtn').hide();
                }
                html += '</div>';

                html += '</div>';

                $('#transactionDetailContent').html(html);
                $('#transactionDetailModal').modal('show');
            }

            // Window resize handler
            $(window).on('resize', function() {
                $dg.datagrid('resize', {
                    height: (window.innerHeight - 550)
                });
            });

            // Focus on transaction ID field on load
            $('#transactionId').focus();
        });
    </script>
}
