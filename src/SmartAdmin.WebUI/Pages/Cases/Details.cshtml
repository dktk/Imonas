@page "{id:int}"
@using Application.Common.Interfaces
@using Microsoft.AspNetCore.Mvc.Localization
@using Domain.Enums
@model SmartAdmin.WebUI.Pages.Cases.DetailsModel
@inject IStringLocalizer<DetailsModel> _localizer
@inject ICurrentUserService _currentUserService

@{
    ViewData["Title"] = "Case Details";
    ViewData["PageName"] = "cases_details";
}

@section HeadBlock {
    <link rel="stylesheet" media="screen, print" href="~/css/fa-solid.css">
}

@if (Model.Case == null)
{
    <div class="alert alert-danger">
        <i class="@(Settings.Theme.IconPrefix) fa-exclamation-triangle mr-2"></i>
        @_localizer["Case not found."]
    </div>
    <a asp-page="Index" class="btn btn-secondary waves-effect waves-themed">
        <i class="@(Settings.Theme.IconPrefix) fa-arrow-left mr-1"></i>
        @_localizer["Back to Cases"]
    </a>
}
else
{
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="subheader-title">
                    <i class="subheader-icon @(Settings.Theme.IconPrefix) fa-folder-open"></i> @Model.Case.CaseNumber
                </h1>
                <small class="text-muted">@Model.Case.Title</small>
            </div>
            <div>
                @if (Model.Case.Status != CaseStatus.Closed)
                {
                    <form method="post" asp-page-handler="Close" style="display: inline;">
                        <button type="submit" class="btn btn-success waves-effect waves-themed mr-2">
                            <i class="@(Settings.Theme.IconPrefix) fa-check mr-1"></i>
                            @_localizer["Close Case"]
                        </button>
                    </form>
                }
                <a asp-page="Index" class="btn btn-secondary waves-effect waves-themed">
                    <i class="@(Settings.Theme.IconPrefix) fa-arrow-left mr-1"></i>
                    @_localizer["Back to Cases"]
                </a>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty((string?)TempData["SuccessMessage"]))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="@(Settings.Theme.IconPrefix) fa-check-circle mr-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true"><i class="@(Settings.Theme.IconPrefix) fa-times"></i></span>
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty((string?)TempData["ErrorMessage"]))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="@(Settings.Theme.IconPrefix) fa-exclamation-circle mr-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true"><i class="@(Settings.Theme.IconPrefix) fa-times"></i></span>
            </button>
        </div>
    }

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-sm-6 col-xl-4">
            <div class="p-3 bg-primary-300 rounded overflow-hidden position-relative text-white mb-g">
                <div>
                    <span class="opacity-70">@_localizer["Status"]</span>
                    <h3 class="display-5 d-block l-h-n m-0 fw-500 mt-2">
                        @if (Model.Case.Status == CaseStatus.Closed)
                        {
                            <span class="badge badge-light" style="font-size: 1.2rem;">@_localizer["Closed"]</span>
                        }
                        else if (Model.Case.Status == CaseStatus.InProgress)
                        {
                            <span class="badge badge-info" style="font-size: 1.2rem;">@_localizer["In Progress"]</span>
                        }
                        else if (Model.Case.Status == CaseStatus.Open)
                        {
                            <span class="badge badge-warning" style="font-size: 1.2rem;">@_localizer["Open"]</span>
                        }
                        else
                        {
                            <span class="badge badge-secondary" style="font-size: 1.2rem;">@Model.Case.Status</span>
                        }
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-4">
            <div class="p-3 @(Model.Case.Severity == CaseSeverity.Critical ? "bg-danger-500" : Model.Case.Severity == CaseSeverity.High ? "bg-warning-600" : "bg-info-500") rounded overflow-hidden position-relative text-white mb-g">
                <div>
                    <span class="opacity-70">@_localizer["Severity"]</span>
                    <h3 class="display-5 d-block l-h-n m-0 fw-500 mt-2">
                        @Model.Case.Severity
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-4">
            <div class="p-3 bg-success-500 rounded overflow-hidden position-relative text-white mb-g">
                <div>
                    <span class="opacity-70">@_localizer["Variance Amount"]</span>
                    <h3 class="display-5 d-block l-h-n m-0 fw-500 mt-2">
                        @(Model.Case.VarianceAmount?.ToString("C") ?? "N/A")
                    </h3>
                    <small class="opacity-70">@Model.Case.VarianceType</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Case Information -->
        <div class="col-xl-6">
            <div id="panel-info" class="panel">
                <div class="panel-hdr">
                    <h2>
                        <i class="@(Settings.Theme.IconPrefix) fa-info-circle mr-2"></i>
                        @_localizer["Case Information"]
                    </h2>
                </div>
                <div class="panel-container show">
                    <div class="panel-content">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <td class="fw-500" style="width: 40%;">@_localizer["Case Number"]</td>
                                    <td>@Model.Case.CaseNumber</td>
                                </tr>
                                <tr>
                                    <td rowspan="2" class="fw-500">@_localizer["Assigned To"]</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(Model.Case.AssignedToDisplayName))
                                        {
                                            <span class="badge badge-primary mr-2" style="font-size: 0.9rem;">
                                                <i class="@(Settings.Theme.IconPrefix) fa-user mr-1"></i>@Model.Case.AssignedToDisplayName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted mr-2">@_localizer["Unassigned"]</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        @if (Model.Case.Status != CaseStatus.Closed)
                                        {
                                            <div class="row">
                                                @if (_currentUserService.DisplayName != Model.Case.AssignedToDisplayName)
                                                {
                                                    <div class="col-6">
                                                        <form method="post" asp-page-handler="Assign" style="display: inline; margin-left: 0.5rem;">
                                                            <button type="submit" class="btn btn-sm btn-outline-primary waves-effect waves-themed">
                                                                <i class="@(Settings.Theme.IconPrefix) fa-user-check mr-1"></i>@_localizer["Assign to Me"]
                                                            </button>
                                                        </form>
                                                    </div>
                                                }
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary waves-effect waves-themed ml-1" data-toggle="modal" data-target="#assignModal">
                                                        <i class="@(Settings.Theme.IconPrefix) fa-users mr-1"></i>@_localizer["Assign to..."]
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-500">
                                        @_localizer["Created by"]
                                    </td>
                                    <td>
                                        @Model.Case.CreatedBy
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-500">@_localizer["Created"]</td>
                                    <td>@Model.Case.Created.ToString("yyyy-MM-dd HH:mm") UTC</td>
                                </tr>
                                <tr>
                                    <td class="fw-500">@_localizer["Due Date"]</td>
                                    <td>
                                        @if (Model.Case.DueDate.HasValue)
                                        {
                                            @Model.Case.DueDate.Value.ToString("yyyy-MM-dd")
                                            @if (Model.Case.DueDate.Value < DateTime.UtcNow && Model.Case.Status != CaseStatus.Closed)
                                            {
                                                <span class="badge badge-danger ml-2">@_localizer["Overdue"]</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">@_localizer["Not set"]</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-500">@_localizer["Root Cause"]</td>
                                    <td>@(Model.Case.RootCauseCode ?? "Not determined")</td>
                                </tr>
                                @if (Model.Case.Status == CaseStatus.Closed)
                                {
                                    <tr>
                                        <td class="fw-500">@_localizer["Resolved"]</td>
                                        <td>@Model.Case.ResolvedAt?.ToString("yyyy-MM-dd HH:mm") UTC by @Model.Case.ResolvedBy</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="panel-desc" class="panel">
                <div class="panel-hdr">
                    <h2>
                        <i class="@(Settings.Theme.IconPrefix) fa-align-left mr-2"></i>
                        @_localizer["Description"]
                    </h2>
                </div>
                <div class="panel-container show">
                    <div class="panel-content">
                        <p style="white-space: pre-wrap;">@Model.Case.Description</p>
                    </div>
                </div>
            </div>

            @if (Model.Case.Status == CaseStatus.Closed && !string.IsNullOrEmpty(Model.Case.ResolutionNotes))
            {
                <div id="panel-resolution" class="panel">
                    <div class="panel-hdr">
                        <h2>
                            <i class="@(Settings.Theme.IconPrefix) fa-check-circle mr-2"></i>
                            @_localizer["Resolution Notes"]
                        </h2>
                    </div>
                    <div class="panel-container show">
                        <div class="panel-content">
                            <p style="white-space: pre-wrap;">@Model.Case.ResolutionNotes</p>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Comments & Attachments -->
        <div class="col-xl-6">
            <div id="panel-comments" class="panel">
                <div class="panel-hdr">
                    <h2>
                        <i class="@(Settings.Theme.IconPrefix) fa-comments mr-2"></i>
                        @_localizer["Comments"] (@Model.Case.Comments.Count)
                    </h2>
                </div>
                <div class="panel-container show">
                    <div class="panel-content">
                        @if (Model.Case.Comments.Any())
                        {
                            <div style="max-height: 400px; overflow-y: auto;">
                                @foreach (var comment in Model.Case.Comments.OrderBy(c => c.Created))
                                {
                                    <div class="bg-fusion-50 rounded p-3 mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <h5 class="text-primary">@comment.CommentedBy</h5>
                                            <small class="text-muted">@comment.Created.ToString("yyyy-MM-dd HH:mm")</small>
                                        </div>
                                        <p class="mb-0" style="white-space: pre-wrap;">@comment.Comment</p>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-center text-muted py-4">
                                <i class="@(Settings.Theme.IconPrefix) fa-comments fa-3x mb-3 d-block opacity-50"></i>
                                @_localizer["No comments yet."]
                            </p>
                        }

                        @if (Model.Case.Status != CaseStatus.Closed)
                        {
                            <form method="post" asp-page-handler="AddComment" class="mt-3">
                                <div class="form-group position-relative">
                                    <textarea id="comment-textarea" name="comment" class="form-control" rows="3" placeholder="@_localizer["Add a comment... Use @ to mention users"]" required></textarea>
                                    <div id="mention-dropdown" class="list-group shadow" style="display:none; position:absolute; z-index:1050; max-height:200px; overflow-y:auto; width:250px;"></div>
                                </div>
                                <button type="submit" class="btn btn-primary waves-effect waves-themed">
                                    <i class="@(Settings.Theme.IconPrefix) fa-comment mr-1"></i>
                                    @_localizer["Add Comment"]
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>

            <div id="panel-attachments" class="panel">
                <div class="panel-hdr">
                    <h2>
                        <i class="@(Settings.Theme.IconPrefix) fa-paperclip mr-2"></i>
                        @_localizer["Attachments"] (@Model.Case.Attachments.Count)
                    </h2>
                </div>
                <div class="panel-container show">
                    <div class="panel-content">
                        @if (Model.Case.Attachments.Any())
                        {
                            @foreach (var attachment in Model.Case.Attachments.OrderByDescending(a => a.Created))
                            {
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <div>
                                        <i class="@(Settings.Theme.IconPrefix) @GetFileIcon(attachment.ContentType) mr-1 text-muted"></i>
                                        <strong>@attachment.FileName</strong>
                                        <div class="small text-muted ml-4">
                                            @FormatFileSize(attachment.FileSizeBytes) &middot; @attachment.Created.ToString("yyyy-MM-dd HH:mm") &middot; @attachment.UploadedBy
                                        </div>
                                    </div>
                                    <div>
                                        <a asp-page="Details" asp-page-handler="DownloadAttachment" asp-route-id="@Model.Case.Id" asp-route-attachmentId="@attachment.Id"
                                           class="btn btn-sm btn-outline-primary waves-effect waves-themed mr-1" title="Download">
                                            <i class="@(Settings.Theme.IconPrefix) fa-download"></i>
                                        </a>
                                        @if (Model.Case.Status != CaseStatus.Closed)
                                        {
                                            <form method="post" asp-page-handler="DeleteAttachment" asp-route-attachmentId="@attachment.Id" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-danger waves-effect waves-themed"
                                                        title="Delete" onclick="return confirm('Delete this attachment?');">
                                                    <i class="@(Settings.Theme.IconPrefix) fa-trash"></i>
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-center text-muted py-3">
                                <i class="@(Settings.Theme.IconPrefix) fa-paperclip fa-2x mb-2 d-block opacity-50"></i>
                                @_localizer["No attachments."]
                            </p>
                        }

                        @if (Model.Case.Status != CaseStatus.Closed)
                        {
                            <form method="post" asp-page-handler="UploadAttachment" enctype="multipart/form-data" class="mt-3">
                                <div class="custom-file mb-2">
                                    <input type="file" class="custom-file-input" id="attachmentFile" name="file" required>
                                    <label class="custom-file-label" for="attachmentFile">@_localizer["Choose file..."]</label>
                                </div>
                                <small class="text-muted d-block mb-2">@_localizer["Maximum file size: 10 MB"]</small>
                                <button type="submit" class="btn btn-secondary waves-effect waves-themed w-100" id="uploadBtn">
                                    <i class="@(Settings.Theme.IconPrefix) fa-upload mr-1"></i>
                                    @_localizer["Upload Attachment"]
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>

            @if (Model.Case.Labels.Any())
            {
                <div id="panel-labels" class="panel">
                    <div class="panel-hdr">
                        <h2>
                            <i class="@(Settings.Theme.IconPrefix) fa-tags mr-2"></i>
                            @_localizer["Labels"]
                        </h2>
                    </div>
                    <div class="panel-container show">
                        <div class="panel-content">
                            @foreach (var label in Model.Case.Labels)
                            {
                                <span class="badge badge-info mr-1 mb-1" style="font-size: 0.9rem;">@label.LabelName</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="row">
        <div id="panel-transactions" class="panel">
            <div class="panel-hdr">
                <h2>
                    <i class="@(Settings.Theme.IconPrefix) fa-align-center mr-2"></i>
                    @_localizer["Transactions"]
                </h2>
                <div class="panel-toolbar">
                    @if (Model.Case.Status != CaseStatus.Closed
                        && (_currentUserService.IsInRole("Finance Admin") || _currentUserService.IsInRole("Admin") || _currentUserService.IsInRole("System Admin")))
                    {
                        <button type="button" class="btn btn-sm btn-warning waves-effect waves-themed" data-toggle="modal" data-target="#manualSettleModal">
                            <i class="@(Settings.Theme.IconPrefix) fa-handshake mr-1"></i>
                            @_localizer["Manual Settle"]
                        </button>
                    }
                </div>
            </div>
            <div class="panel-container show">
                <div class="panel-content">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>@_localizer["Id"]</th>
                                <th>@_localizer["Source"]</th>
                                <th>@_localizer["Amount"]</th>
                                <th>@_localizer["Currency"]</th>
                                <th>@_localizer["Status"]</th>
                                <th>@_localizer["Date"]</th>
                                <th>@_localizer["ExternalPaymentId"]</th>
                                <th>@_localizer["Rule"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>@Model.Case.InternalTransaction.Id</td>
                                <td><strong>@Model.Case.InternalTransaction.Source</strong></td>
                                <td>@Model.Case.InternalTransaction.Amount</td>
                                <td>@Model.Case.InternalTransaction.CurrencyCode</td>
                                <td>@Model.Case.InternalTransaction.Status</td>
                                <td>@Model.Case.InternalTransaction.TransactionDate</td>
                                <td>@Model.Case.InternalTransaction.ExternalPaymentId</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>@Model.Case.ExternalTransaction.Id</td>
                                <td><strong>@Model.Case.ExternalTransaction.Source</strong></td>
                                <td>@Model.Case.ExternalTransaction.Amount</td>
                                <td>@Model.Case.ExternalTransaction.CurrencyCode</td>
                                <td>@Model.Case.ExternalTransaction.Status</td>
                                <td>@Model.Case.ExternalTransaction.Amount</td>
                                <td>@Model.Case.ExternalTransaction.TransactionDate</td>
                                <td>@Model.Case.ExternalTransaction.ExternalPaymentId</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign User Modal -->
    @if (Model.Case.Status != CaseStatus.Closed)
    {
        <div class="modal fade" id="assignModal" tabindex="-1" role="dialog" aria-labelledby="assignModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form method="post" asp-page-handler="Assign">
                        <div class="modal-header bg-primary-600">
                            <h5 class="modal-title text-white" id="assignModalLabel">
                                <i class="@(Settings.Theme.IconPrefix) fa-user-check mr-2"></i>
                                @_localizer["Assign Case"]
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">@_localizer["Select User"]</label>
                                <select name="assignedTo" id="assignUserSelect" class="form-control">
                                    <option value="">-- @_localizer["Loading users..."] --</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">@_localizer["Cancel"]</button>
                            <button type="submit" class="btn btn-primary" id="confirmAssignBtn">
                                <i class="@(Settings.Theme.IconPrefix) fa-check mr-1"></i>
                                @_localizer["Assign"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }

    <!-- Manual Settlement Modal -->
    @if (Model.Case.Status != CaseStatus.Closed
        && (_currentUserService.IsInRole("Finance Admin") || _currentUserService.IsInRole("Admin") || _currentUserService.IsInRole("System Admin")))
    {
        <div class="modal fade" id="manualSettleModal" tabindex="-1" role="dialog" aria-labelledby="manualSettleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <form method="post" asp-page-handler="ManualSettle">
                        <div class="modal-header bg-warning-600">
                            <h5 class="modal-title text-white" id="manualSettleModalLabel">
                                <i class="@(Settings.Theme.IconPrefix) fa-handshake mr-2"></i>
                                @_localizer["Confirm Manual Settlement"]
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-primary fw-500">
                                        <i class="@(Settings.Theme.IconPrefix) fa-arrow-right mr-1"></i>
                                        @_localizer["Internal Transaction"]
                                    </h6>
                                    <table class="table table-sm table-bordered mb-0">
                                        <tr>
                                            <td class="fw-500">@_localizer["Source"]</td>
                                            <td>@Model.Case.InternalTransaction?.Source</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-500">@_localizer["Amount"]</td>
                                            <td>@Model.Case.InternalTransaction?.Amount.ToString("N2") @Model.Case.InternalTransaction?.CurrencyCode</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-500">@_localizer["Date"]</td>
                                            <td>@Model.Case.InternalTransaction?.TransactionDate.ToString("yyyy-MM-dd")</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-500">@_localizer["Status"]</td>
                                            <td>@Model.Case.InternalTransaction?.Status</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-info fw-500">
                                        <i class="@(Settings.Theme.IconPrefix) fa-arrow-left mr-1"></i>
                                        @_localizer["External Transaction"]
                                    </h6>
                                    <table class="table table-sm table-bordered mb-0">
                                        <tr>
                                            <td class="fw-500">@_localizer["Source"]</td>
                                            <td>@Model.Case.ExternalTransaction?.Source</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-500">@_localizer["Amount"]</td>
                                            <td>@Model.Case.ExternalTransaction?.Amount.ToString("N2") @Model.Case.ExternalTransaction?.CurrencyCode</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-500">@_localizer["Date"]</td>
                                            <td>@Model.Case.ExternalTransaction?.TransactionDate.ToString("yyyy-MM-dd")</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-500">@_localizer["Status"]</td>
                                            <td>@Model.Case.ExternalTransaction?.Status</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            @if (Model.Case.InternalTransaction != null && Model.Case.ExternalTransaction != null)
                            {
                                var amountDiff = Model.Case.InternalTransaction.Amount - Model.Case.ExternalTransaction.Amount;
                                var dateDiff = (Model.Case.InternalTransaction.TransactionDate - Model.Case.ExternalTransaction.TransactionDate).Days;
                                <div class="alert @(amountDiff == 0 ? "alert-success" : "alert-warning") py-2 mb-3">
                                    <div class="d-flex justify-content-around">
                                        <span>
                                            <strong>@_localizer["Amount Variance"]:</strong>
                                            @amountDiff.ToString("N2") @Model.Case.InternalTransaction.CurrencyCode
                                        </span>
                                        <span>
                                            <strong>@_localizer["Date Variance"]:</strong>
                                            @Math.Abs(dateDiff) @_localizer["day(s)"]
                                        </span>
                                    </div>
                                </div>
                            }

                            <div class="form-group">
                                <label class="form-label fw-500">
                                    @_localizer["Description"] <span class="text-danger">*</span>
                                </label>
                                <textarea name="description" class="form-control" rows="3" required
                                          placeholder="@_localizer["Explain why these transactions should be manually settled..."]"></textarea>
                            </div>

                            <div class="alert alert-info py-2 mb-0">
                                <i class="@(Settings.Theme.IconPrefix) fa-info-circle mr-1"></i>
                                @_localizer["This action will create a settlement record and close this case."]
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">@_localizer["Cancel"]</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="@(Settings.Theme.IconPrefix) fa-handshake mr-1"></i>
                                @_localizer["Confirm Settlement"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
}

@functions {
    string GetFileIcon(string contentType)
    {
        if (string.IsNullOrEmpty(contentType)) return "fa-file";
        if (contentType.StartsWith("image/")) return "fa-file-image";
        if (contentType == "application/pdf") return "fa-file-pdf";
        if (contentType.Contains("spreadsheet") || contentType.Contains("excel") || contentType == "text/csv") return "fa-file-excel";
        if (contentType.Contains("word") || contentType.Contains("document")) return "fa-file-word";
        if (contentType.StartsWith("text/")) return "fa-file-alt";
        if (contentType.Contains("zip") || contentType.Contains("compressed") || contentType.Contains("archive")) return "fa-file-archive";
        return "fa-file";
    }

    string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}

@section ScriptsBlock {
    <script>
        // File input label update
        $(document).on('change', '.custom-file-input', function () {
            var fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').text(fileName || 'Choose file...');
        });

        (function () {
            var cachedUsers = null;
            var $textarea = $('#comment-textarea');
            var $dropdown = $('#mention-dropdown');
            var selectedIndex = -1;

            if (!$textarea.length) return;

            function fetchUsers() {
                if (cachedUsers) return Promise.resolve(cachedUsers);
                return axios.get('/api/users').then(function (res) {
                    cachedUsers = (res.data.data || res.data || []).filter(function (u) { return u.isActive; });
                    return cachedUsers;
                });
            }

            // Preload user list
            fetchUsers();

            function getMentionContext() {
                var el = $textarea[0];
                var pos = el.selectionStart;
                var text = el.value.substring(0, pos);
                var atIdx = text.lastIndexOf('@@');
                if (atIdx === -1) return null;
                // Ensure @@ is at start or preceded by whitespace
                if (atIdx > 0 && !/\s/.test(text[atIdx - 1])) return null;
                var query = text.substring(atIdx + 1);
                // No newlines in the query
                if (query.indexOf('\n') !== -1) return null;
                return { atIndex: atIdx, query: query };
            }

            function showDropdown(users) {
                $dropdown.empty();
                if (users.length === 0) {
                    $dropdown.hide();
                    return;
                }
                users.slice(0, 8).forEach(function (u, i) {
                    $dropdown.append(
                        '<a href="#" class="list-group-item list-group-item-action mention-option py-1 px-2' + (i === selectedIndex ? ' active' : '') + '" data-display-name="' + escapeAttr(u.displayName) + '">' +
                            '<strong>' + escapeHtml(u.displayName) + '</strong>' +
                            '<small class="text-muted ml-2">' + escapeHtml(u.email || '') + '</small>' +
                        '</a>'
                    );
                });
                $dropdown.show();
            }

            function escapeHtml(str) {
                if (!str) return '';
                var div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }

            function escapeAttr(str) {
                return (str || '').replace(/"/g, '&quot;');
            }

            function insertMention(displayName) {
                var el = $textarea[0];
                var pos = el.selectionStart;
                var text = el.value;
                var before = text.substring(0, pos);
                var atIdx = before.lastIndexOf('@@');
                var after = text.substring(pos);
                var mention = '@@' + displayName + ' ';
                el.value = text.substring(0, atIdx) + mention + after;
                var newPos = atIdx + mention.length;
                el.selectionStart = newPos;
                el.selectionEnd = newPos;
                el.focus();
                $dropdown.hide();
                selectedIndex = -1;
            }

            $textarea.on('input', function () {
                var ctx = getMentionContext();
                if (!ctx) {
                    $dropdown.hide();
                    selectedIndex = -1;
                    return;
                }
                fetchUsers().then(function (users) {
                    var q = ctx.query.toLowerCase();
                    var filtered = users.filter(function (u) {
                        return u.displayName && u.displayName.toLowerCase().indexOf(q) !== -1;
                    });
                    selectedIndex = filtered.length > 0 ? 0 : -1;
                    showDropdown(filtered);
                });
            });

            $textarea.on('keydown', function (e) {
                if (!$dropdown.is(':visible')) return;
                var $items = $dropdown.find('.mention-option');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, $items.length - 1);
                    $items.removeClass('active').eq(selectedIndex).addClass('active');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    $items.removeClass('active').eq(selectedIndex).addClass('active');
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    if (selectedIndex >= 0 && $items.length > 0) {
                        e.preventDefault();
                        var name = $items.eq(selectedIndex).data('display-name');
                        insertMention(name);
                    }
                } else if (e.key === 'Escape') {
                    $dropdown.hide();
                    selectedIndex = -1;
                }
            });

            $(document).on('click', '.mention-option', function (e) {
                e.preventDefault();
                var name = $(this).data('display-name');
                insertMention(name);
            });

            $(document).on('click', function (e) {
                if (!$(e.target).closest('#mention-dropdown, #comment-textarea').length) {
                    $dropdown.hide();
                    selectedIndex = -1;
                }
            });
        })();

        // Assignment modal - load users
        (function () {
            var usersLoaded = false;
            $('#assignModal').on('show.bs.modal', function () {
                if (usersLoaded) return;
                axios.get('/api/users').then(function (res) {
                    var users = (res.data.data || res.data || []).filter(function (u) { return u.isActive; });
                    var $select = $('#assignUserSelect');
                    $select.empty();
                    $select.append('<option value="">-- Select a user --</option>');
                    users.forEach(function (u) {
                        $select.append('<option value="' + (u.displayName || u.userName || '') + '">' + (u.displayName || u.userName) + ' (' + (u.email || '') + ')</option>');
                    });
                    usersLoaded = true;
                });
            });
        })();
    </script>
}
